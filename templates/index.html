<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Companion Chat</title>
    <style>
      :root{
        --bg:#0f1724;
        --card:#0b1220;
        --accent:#6ee7b7;
        --muted:#9aa4b2;
        --user:#0ea5a4;
      }
      html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071021 0%, #0f1724 100%);color:#e6eef8}
      .container{max-width:900px;margin:32px auto;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
      header{display:flex;align-items:center;gap:12px}
      .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#062022}
      h1{margin:0;font-size:1.25rem}
      p.lead{margin:4px 0 14px;color:var(--muted)}

      .chat-window{height:520px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:16px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
      .message{display:flex;gap:12px;margin:8px 0;align-items:flex-end}
      .message.user{justify-content:flex-end}
      .bubble{max-width:70%;padding:12px 14px;border-radius:14px;background:#0b2130;color:#e6f8f0;box-shadow:0 6px 16px rgba(3,10,18,0.5)}
      .bubble.user{background:linear-gradient(90deg,var(--user),#4dd0e1);color:#042023;border-bottom-right-radius:4px}
      .avatar{width:36px;height:36px;border-radius:50%;background:#0b1220;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700}
      .meta{font-size:0.8rem;color:var(--muted);margin-top:6px}

      .composer{display:flex;gap:12px;margin-top:12px;align-items:flex-end}
      .controls{display:flex;flex-direction:column;gap:8px}
      .file-label{display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}

      textarea#prompt{width:100%;min-height:64px;border-radius:10px;padding:12px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit;resize:vertical}
      .actions{display:flex;gap:8px;align-items:center}
      button{background:var(--accent);color:#042022;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
      button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

      .thumb{max-width:180px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:block;margin-top:8px}
      .typing{height:18px;width:48px;display:flex;gap:6px;align-items:center}
      .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.18);animation:blink 1.2s infinite}
      .dot:nth-child(2){animation-delay:0.12s}
      .dot:nth-child(3){animation-delay:0.24s}
      @keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}

      footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:0.85rem}

      @media (max-width:720px){.container{margin:10px;padding:12px}.chat-window{height:420px}}
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">CO</div>
        <div>
          <h1>Companion Chat</h1>
          <p class="lead">Upload a photo and talk gently — the assistant will respond with supportive replies.</p>
        </div>
      </header>

      <div id="chat" class="chat-window" aria-live="polite"></div>

      <div class="composer">
        <div style="flex:1">
          <label class="file-label" for="image">Choose image</label>
          <input id="image" type="file" accept="image/*" style="display:none" />
          <div id="previewWrap"></div>
          <textarea id="prompt" placeholder="Say something supportive or describe what you want to discuss..."></textarea>
          <div class="actions">
            <button id="sendBtn">Send</button>
            <button id="clearBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
      </div>

      <footer>
        <div>Local Flask endpoint: <code>http://127.0.0.1:5000/upload</code></div>
        <div id="status" style="text-align:right">Ready</div>
      </footer>
    </div>

    <script>
      const chat = document.getElementById('chat');
      const imageInput = document.getElementById('image');
      const previewWrap = document.getElementById('previewWrap');
      const promptEl = document.getElementById('prompt');
      const sendBtn = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');
      const status = document.getElementById('status');

      // helper to append a message
      function appendMessage({role='assistant', text='', img=null, meta=''}){
        const m = document.createElement('div');
        m.className = 'message ' + (role==='user' ? 'user' : 'assistant');
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = role === 'user' ? 'You' : 'AI';
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (role==='user' ? 'user' : '');
        if(text) bubble.textContent = text;
        if(img){
          const im = document.createElement('img'); im.src = img; im.className = 'thumb'; bubble.appendChild(im);
        }
        const left = document.createElement('div');
        left.appendChild(avatar);
        const right = document.createElement('div');
        right.appendChild(bubble);
        if(role==='user'){
          m.appendChild(right);
          m.appendChild(left);
        } else {
          m.appendChild(left);
          m.appendChild(right);
        }
        chat.appendChild(m);
        chat.scrollTop = chat.scrollHeight;
      }

      // simple typing indicator
      function appendTyping(){
        const s = document.createElement('div'); s.className='message';
        s.id = 'typing';
        const av = document.createElement('div'); av.className='avatar'; av.textContent='AI';
        const bub = document.createElement('div'); bub.className='bubble';
        const t = document.createElement('div'); t.className='typing'; t.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        bub.appendChild(t);
        s.appendChild(av); s.appendChild(bub);
        chat.appendChild(s); chat.scrollTop = chat.scrollHeight;
      }
      function removeTyping(){ const t = document.getElementById('typing'); if(t) t.remove(); }

      // preview image handling
      document.querySelector('.file-label').addEventListener('click', ()=>imageInput.click());
      imageInput.addEventListener('change', ()=>{
        previewWrap.innerHTML='';
        const f = imageInput.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        const img = document.createElement('img'); img.src=url; img.className='thumb'; previewWrap.appendChild(img);
      });

      clearBtn.addEventListener('click', ()=>{
        promptEl.value = '';
        imageInput.value = '';
        previewWrap.innerHTML = '';
      });

      sendBtn.addEventListener('click', async ()=>{
        const prompt = promptEl.value.trim();
        const file = imageInput.files[0];
        if(!file){ alert('Please choose an image to send (server expects an image).'); return; }
        if(!prompt){ if(!confirm('Send image without any prompt?')) return; }

        // show user's message
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = e.target.result;
          appendMessage({role:'user', text: prompt || '(image only)', img: base64});
          status.textContent = 'Sending...';
          sendBtn.disabled = true; promptEl.disabled = true; imageInput.disabled = true;
          appendTyping();

          try{
            const resp = await fetch('/upload', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({image: base64, prompt: prompt})});
            const json = await resp.json();
            removeTyping();
            if(resp.ok){
              const text = json.response || JSON.stringify(json);
              appendMessage({role:'assistant', text});
              status.textContent = `OK (${resp.status})`;
            } else {
              const err = json.error || json;
              appendMessage({role:'assistant', text: 'Error: ' + (typeof err==='string'?err:JSON.stringify(err))});
              status.textContent = `Error (${resp.status})`;
            }
          } catch(err){
            removeTyping();
            appendMessage({role:'assistant', text: 'Connection error: '+err});
            status.textContent = 'Request failed';
          } finally{
            sendBtn.disabled = false; promptEl.disabled = false; imageInput.disabled = false;
          }
        };
        reader.readAsDataURL(file);
      });

      // welcome message
      appendMessage({role:'assistant', text: 'Hi — I am here to listen. Upload a photo and tell me how you are feeling.'});
    </script>
  </body>
</html>
